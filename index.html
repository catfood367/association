<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Treino de associaÃ§Ã£o</title>
<style>
    body {
        margin: 0;
        padding: 0;
        background: #f5f5f5;
        overflow: hidden;
        font-family: Arial, sans-serif;
        user-select: none;
        width: 100vw;
        height: 100vh;
        transition: background-color 0.3s ease;
    }
    body.dark-mode {
        background: #000000;
    }
    .syllable {
        position: absolute;
        font-size: 40px;
        font-weight: bold;
        text-align: left;
        line-height: 1.2;
        cursor: default;
        display: inline-block;
    }
    .translation {
        font-size: 30px;
        font-weight: bold;
        display: block;
        margin-top: 5px;
        white-space: nowrap;
        text-align: left;
        position: absolute;
        left: 0;
        top: 100%;
    }
    #scorePanel {
        position: fixed;
        top: 10px;
        left: 10px;
        font-size: 24px;
        font-weight: bold;
        background: rgba(0,0,0,0.6);
        color: #fff;
        padding: 8px 15px;
        border-radius: 8px;
        z-index: 9999;
        user-select: none;
        font-family: 'Arial Black', Arial, sans-serif;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #settingsBtn {
        cursor: pointer;
        background-color: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
    }
    #settingsBtn img {
        width: 30px;
    }
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 10000;
        font-family: 'Arial Black', Arial, sans-serif;
    }
    .modal-content {
        padding: 30px 40px;
        border-radius: 15px;
        text-align: center;
        color: white;
        max-width: 90vw;
        width: 400px;
        background: #333;
    }
    .modal-content h1 {
        font-size: 2rem;
        margin-bottom: 20px;
    }
    .modal-content label {
        display: block;
        margin-top: 10px;
        text-align: left;
        font-size: 1.2rem;
    }
    .modal-content input, .modal-content select {
        margin-top: 5px;
    }
    .modal-content div {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        margin-top: 30px;
    }
    .btn-restart, .btn-close {
        margin-top: 20px;
        font-size: 1rem;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background: rgb(0, 138, 0);
        color: white;
        font-weight: 900;
        cursor: pointer;
        transition: background-color 0.25s ease;
        user-select: none;
    }
    .btn-close {
        background: red;
    }
    #voiceSelect {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: rgb(0, 182, 173);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        max-width: 400px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
    }
    #answerTipRange {
        width: 200px;
    }
    #answerTipValue {
        display: inline-block;
        margin-left: 10px;
        font-weight: bold;
    }
</style>
</head>
<body>

<div id="congratsModal" class="modal">
    <div class="modal-content">
        <h1>ðŸŽ‰ ParabÃ©ns! ðŸŽ‰</h1>
        <p>VocÃª terminou o jogo!!!</p>
        <button id="restartBtn" class="btn-restart">Reiniciar</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <label>
            NÃºmero de letras da dica:
            <input type="range" id="answerTipRange" min="0" max="3" value="1" step="1">
            <span id="answerTipValue">1</span>
        </label>

        <label>
            Dica de Cor:
            <input type="checkbox" id="colorHintToggle" checked>
        </label>

        <label>
            Dica de PosiÃ§Ã£o:
            <input type="checkbox" id="positionHintToggle" checked>
        </label>

        <label>
            Ordem AleatÃ³ria:
            <input type="checkbox" id="randomToggle">
        </label>

        <br>

        <label>
            Som de Acerto:
            <input type="checkbox" id="correctSoundToggle" checked>
        </label>

        <label>
            Som de Erro:
            <input type="checkbox" id="wrongSoundToggle" checked>
        </label>

        <label>
            Modo Escuro:
            <input type="checkbox" id="darkModeToggle">
        </label>

        <label style="margin-top:30px;">
            Voz da leitura: &nbsp;<select id="voiceSelect"></select>
        </label>

        <div>
            <label>
                Arquivo selecionado:
                <span id="fileName">Nenhum</span>
            </label>
            <button id="fileSelectBtn" class="btn-restart">Selecionar Arquivo</button>
        </div>
    </div>
</div>

<div id="scorePanel">
    <button id="settingsBtn"><img src="https://static.vecteezy.com/system/resources/previews/047/429/167/non_2x/blue-settings-icon-free-png.png" alt=""></button>
    <span id="scoreText">| PontuaÃ§Ã£o: 0 | Level: 0 / 0</span>
</div>

<input type="file" id="fileInput" accept=".json" style="display:none;">

<script>
(() => {
    const groupSize = 5;

    let syllableList = [];
    let currentGroupIndex = 0;
    let currentGroup = [];
    let currentSyllable = null;
    let currentSyllableElement = null;
    let translationElement = null;
    let userTyped = '';
    let score = 0;
    let hintUsed = false;

    let selectedVoice = null;
    let correctSoundEnabled = true;
    let wrongSoundEnabled = true;
    let randomToggleEnabled = false;
    let colorHintEnabled = true;
    let positionHintEnabled = true;
    let darkModeEnabled = false;
    let answerTipLetters = 1;
    let utterance = null;

    const correctSound = new Audio('right.mp3');
    const wrongSound = new Audio('wrong.mp3');

    const scoreText = document.getElementById('scoreText');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');

    const settingsModal = document.getElementById('settingsModal');
    const settingsBtn = document.getElementById('settingsBtn');
    const fileSelectBtn = document.getElementById('fileSelectBtn');

    const correctSoundToggle = document.getElementById('correctSoundToggle');
    const wrongSoundToggle = document.getElementById('wrongSoundToggle');
    const randomToggle = document.getElementById("randomToggle");
    const colorHintToggle = document.getElementById("colorHintToggle");
    const positionHintToggle = document.getElementById("positionHintToggle");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const voiceSelect = document.getElementById('voiceSelect');
    const answerTipRange = document.getElementById('answerTipRange');
    const answerTipValue = document.getElementById('answerTipValue');

    function populateVoices() {
        const voices = speechSynthesis.getVoices();
        voiceSelect.innerHTML = '<option value="none">Nenhuma</option>';
        voices.forEach((voice, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.textContent = `${voice.name} (${voice.lang})`;
            voiceSelect.appendChild(opt);
        });
    }

    speechSynthesis.onvoiceschanged = populateVoices;
    populateVoices();

    correctSoundToggle.addEventListener('change', () => {
        correctSoundEnabled = correctSoundToggle.checked;
        savePreferences();
    });
    wrongSoundToggle.addEventListener('change', () => {
        wrongSoundEnabled = wrongSoundToggle.checked;
        savePreferences();
    });

    answerTipRange.addEventListener('input', () => {
        answerTipLetters = parseInt(answerTipRange.value);
        answerTipValue.textContent = answerTipLetters;
        savePreferences();
        if (syllableList.length > 0) {
            displaySyllable();
        }
    });

    function shuffle(lista) {
        for (let i = lista.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [lista[i], lista[j]] = [lista[j], lista[i]];
        }
        return lista;
    }

    randomToggle.addEventListener('change', () => {
        randomToggleEnabled = randomToggle.checked;
        savePreferences();
        if (syllableList.length > 0) {
            startGame();
        }
    });

    colorHintToggle.addEventListener('change', () => {
        colorHintEnabled = colorHintToggle.checked;
        savePreferences();
        if (syllableList.length > 0) {
            displaySyllable();
        }
    });

    positionHintToggle.addEventListener('change', () => {
        positionHintEnabled = positionHintToggle.checked;
        savePreferences();
        if (syllableList.length > 0) {
            displaySyllable();
        }
    });

    darkModeToggle.addEventListener('change', () => {
        darkModeEnabled = darkModeToggle.checked;
        document.body.classList.toggle('dark-mode', darkModeEnabled);
        savePreferences();
        if (syllableList.length > 0) {
            displaySyllable();
        }
    });

    selectVoice = () => {
        if (voiceSelect.value === 'none') {
            selectedVoice = null;
            utterance = null;
            savePreferences();
            return;
        }

        selectedVoice = speechSynthesis.getVoices()[voiceSelect.value];
        utterance = new SpeechSynthesisUtterance();
        utterance.voice = selectedVoice;
        savePreferences();

        if (currentSyllable?.question) {
            utterance.text = currentSyllable.question;
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            speechSynthesis.speak(utterance);
        }
    };

    voiceSelect.addEventListener('change', selectVoice);

    settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
    });

    fileSelectBtn.addEventListener('click', () => {
        fileInput.click();
    });

    settingsModal.addEventListener('click', (e) => {
        if (e.target.id === "settingsModal") {
            settingsModal.style.display = 'none';
        }
    });
    
    function parseSyllableData(jsonData) {
        try {
            const data = JSON.parse(jsonData);
            if (!Array.isArray(data)) {
                alert('JSON deve ser um array');
                return [];
            }
            return data.filter(item => item.question && item.answer);
        } catch (error) {
            alert('Erro ao parsear JSON:', error);
            return [];
        }
    }

    fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async evt => {
            const fileContent = evt.target.result;
            syllableList = parseSyllableData(fileContent);
            if (!syllableList.length) {
                alert('Arquivo vazio ou invÃ¡lido');
                return;
            }
            
            const storageData = {
                content: fileContent,
                name: file.name
            };
            const result = localStorage.setItem('saved_file', JSON.stringify(storageData));

            fileName.textContent = file.name;
            startGame();
        };
        reader.readAsText(file);
    });

    async function savePreferences() {
        const preferences = {
            correctSoundEnabled,
            wrongSoundEnabled,
            randomToggleEnabled,
            colorHintEnabled,
            positionHintEnabled,
            darkModeEnabled,
            answerTipLetters,
            voiceIndex: voiceSelect.value
        };

        localStorage.setItem('user_preferences', JSON.stringify(preferences));
    }

    async function loadPreferences() {
        const result = localStorage.getItem('user_preferences');
        if (result && result) {
            const preferences = JSON.parse(result);
            
            correctSoundEnabled = preferences.correctSoundEnabled ?? true;
            wrongSoundEnabled = preferences.wrongSoundEnabled ?? true;
            randomToggleEnabled = preferences.randomToggleEnabled ?? false;
            colorHintEnabled = preferences.colorHintEnabled ?? true;
            positionHintEnabled = preferences.positionHintEnabled ?? true;
            darkModeEnabled = preferences.darkModeEnabled ?? false;
            answerTipLetters = preferences.answerTipLetters ?? 1;
            
            correctSoundToggle.checked = correctSoundEnabled;
            wrongSoundToggle.checked = wrongSoundEnabled;
            randomToggle.checked = randomToggleEnabled;
            colorHintToggle.checked = colorHintEnabled;
            positionHintToggle.checked = positionHintEnabled;
            darkModeToggle.checked = darkModeEnabled;
            answerTipRange.value = answerTipLetters;
            answerTipValue.textContent = answerTipLetters;
            
            document.body.classList.toggle('dark-mode', darkModeEnabled);
            
            if (preferences.voiceIndex) {
                voiceSelect.value = preferences.voiceIndex;
                if (preferences.voiceIndex !== 'none') {
                    setTimeout(() => {
                        voiceSelect.value = preferences.voiceIndex;
                        selectVoice();
                    }, 500);
                }
            }
        }
    }

    function hashCode(str) {
        let hash = 2166136261;
        for (let i = 0; i < str.length; i++) {
            hash ^= str.charCodeAt(i);
            hash += (hash << 1) + (hash << 4) + (hash << 7) + (hash << 8) + (hash << 24);
        }
        return Math.abs(hash >>> 0);
    }

    function generateColor(str) {
        const hash = hashCode(str);
        const hue = (hash * 137) % 360;
        const saturation = 85 + (hash % 15);
        
        let lightness;
        if (darkModeEnabled) {
            lightness = 60 + (hash % 16);
        } else {
            lightness = 35 + (hash % 16);
        }
        
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    function generatePosition(str) {
        const hash = hashCode(str);
        const marginTop = 80;
        const marginBottom = 150;
        const marginLeft = 100;
        const marginRight = 100;
        
        const tempEl = document.createElement('div');
        tempEl.classList.add('syllable');
        tempEl.textContent = str;
        tempEl.style.visibility = 'hidden';
        tempEl.style.position = 'absolute';
        
        document.body.appendChild(tempEl);
        
        const elWidth = tempEl.offsetWidth;
        const elHeight = tempEl.offsetHeight;
        
        document.body.removeChild(tempEl);

        const maxX = window.innerWidth - marginRight - elWidth;
        const maxY = window.innerHeight - marginBottom - elHeight;
        const minX = marginLeft;
        const minY = marginTop;

        const rangeX = Math.max(1, maxX - minX + 1);
        const rangeY = Math.max(1, maxY - minY + 1);

        let x = minX + (Math.abs(hash) % rangeX);
        let y = minY + (Math.abs(hash >> 8) % rangeY);

        x = Math.min(Math.max(x, minX), maxX);
        y = Math.min(Math.max(y, minY), maxY);

        return { x, y };
    }
    
    function updateScoreDisplay() {
        const totalLevels = Math.ceil(syllableList.length / groupSize);
        scoreText.textContent = `PontuaÃ§Ã£o: ${score} | Level: ${currentGroupIndex + 1} / ${totalLevels}`;
    }

    function showCongrats() {
        const modal = document.getElementById('congratsModal');
        modal.style.display = 'flex';

        const restartBtn = document.getElementById('restartBtn');

        const closeModal = () => {
            modal.style.display = 'none';
            document.removeEventListener('keydown', onKeyDown);
            startGame();
        };

        restartBtn.onclick = closeModal;

        const onKeyDown = (e) => {
            if (e.key === 'Enter') closeModal();
        };

        document.addEventListener('keydown', onKeyDown);
    }

    function loadGroup(index) {
        const start = index * groupSize;
        currentGroup = syllableList.slice(start, start + groupSize);

        if (currentGroup.length === 0 && syllableList.length > 0) {
            showCongrats();
        }
    }

    let lastPickedIndex = -1;
    function pickRandomSyllable() {
        if (currentGroup.length === 0) {
            currentGroupIndex++;
            loadGroup(currentGroupIndex);
        }
        if (currentGroup.length === 0) return null;

        let randomIndex;

        do {
            randomIndex = Math.floor(Math.random() * currentGroup.length);
        } while (currentGroup.length > 1 && randomIndex === lastPickedIndex);

        lastPickedIndex = randomIndex;

        return { syllable: currentGroup[randomIndex], index: randomIndex };
    }

    function displaySyllable() {
        if (!currentGroup.length) return;

        userTyped = '';
        hintUsed = false;

        const picked = pickRandomSyllable();
        if (!picked) return;

        currentSyllable = picked.syllable;
        currentSyllable.pickIndex = picked.index;

        if (selectedVoice && utterance) {
            utterance.text = currentSyllable.question;
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            speechSynthesis.speak(utterance);
        }

        const color = generateColor(currentSyllable.question);

        if (currentSyllableElement) currentSyllableElement.remove();

        const syllableEl = document.createElement('div');
        syllableEl.classList.add('syllable');
        syllableEl.style.position = 'relative';

        syllableEl.style.color = colorHintEnabled ? color : (darkModeEnabled ? '#ffffff' : '#000000');

        let placeholder = currentSyllable.answer.length - answerTipLetters > 0 ? "~" : "";
        
        if (answerTipLetters > 0) {
            syllableEl.textContent = currentSyllable.question + " â†’ " + currentSyllable.answer.substring(0, answerTipLetters) + placeholder;
        } else {
            syllableEl.textContent = currentSyllable.question;
        }

        translationElement = document.createElement('span');
        translationElement.classList.add('translation');
        translationElement.style.color = colorHintEnabled ? color : (darkModeEnabled ? '#ffffff' : '#000000');
        translationElement.textContent = '';

        syllableEl.appendChild(translationElement);
        
        currentSyllableElement = syllableEl;
        document.body.appendChild(syllableEl);

        if (positionHintEnabled) {
            const { x, y } = generatePosition(syllableEl.textContent);
            syllableEl.style.left = x + 'px';
            syllableEl.style.top = y + 'px';
        } else {
            syllableEl.style.left = '50%';
            syllableEl.style.top = '50%';
            syllableEl.style.transform = 'translate(-50%, -50%)';
        }
    }

    function startGame() {
        if (syllableList.length === 0) return;

        currentGroupIndex = 0;
        currentGroup = [];
        currentSyllable = null;
        if (currentSyllableElement) currentSyllableElement.remove();
        if (translationElement) translationElement.remove();

        if (randomToggleEnabled) {
            syllableList = shuffle([...syllableList]);
        }

        score = 0;
        loadGroup(currentGroupIndex);
        updateScoreDisplay();
        displaySyllable();
    }

    async function loadSavedFile() {
        const result = localStorage.getItem('saved_file');
        if (result && result) {
            const storageData = JSON.parse(result);
            syllableList = parseSyllableData(storageData.content);
            if (syllableList.length > 0) {
                fileName.textContent = storageData.name || 'Arquivo salvo';               
            }
        }
    }
    
    async function init() {
        await loadPreferences();
        await loadSavedFile();

        if (syllableList.length > 0) {
            startGame();
        }
    }
    
    init();

    function createParticle(element) {
        const rect = element.getBoundingClientRect();

        const particle = document.createElement('div');
        particle.style.position = 'fixed';
        particle.style.left = (rect.left + rect.width / 2 - 4) + 'px';
        particle.style.top = rect.top + 'px';
        particle.style.width = '10px';
        particle.style.height = '10px';
        particle.style.backgroundColor = element.style.color;
        particle.style.borderRadius = '0';
        particle.style.zIndex = '100000';
        particle.style.opacity = '1';
        particle.style.pointerEvents = 'none';

        document.body.appendChild(particle);

        let posY = rect.top;
        const speed = 15 + Math.random() * 2;

        function fall() {
            posY += speed;
            particle.style.top = posY + 'px';
            particle.style.opacity = 1 - posY / window.innerHeight;

            if (posY > window.innerHeight) {
                particle.remove();
            } else {
                requestAnimationFrame(fall);
            }
        }

        requestAnimationFrame(fall);
    }

    document.addEventListener('keydown', e => {
        if (!currentSyllable || !currentSyllable.answer) return;

        const key = e.key.toLowerCase();

        if (/^[a-z ']$/.test(key) && key.length === 1) {
            userTyped += key;
            if (translationElement) {
                translationElement.textContent = userTyped;
            }
        } else if (e.key === 'Backspace') {
            userTyped = userTyped.slice(0, -1);
            if (translationElement) {
                translationElement.textContent = userTyped;
            }
        } else if (e.key === 'Enter') {
            if (userTyped === currentSyllable.answer) {
                if (!hintUsed) {
                    if (correctSoundEnabled) {
                        correctSound.currentTime = 0;
                        correctSound.play();
                    }
                   
                    if (currentSyllableElement) {
                        createParticle(currentSyllableElement);
                    }
                    score++;
                  
                    updateScoreDisplay();
                    currentGroup.splice(currentSyllable.pickIndex, 1);

                    if (currentGroup.length === 0) {
                        currentGroupIndex++;
                        loadGroup(currentGroupIndex);
                    }
                }

                if (translationElement) {
                    translationElement.textContent = '';
                }
                if (currentSyllableElement) {
                    currentSyllableElement.remove();
                }

                displaySyllable();
            } else {
                if (wrongSoundEnabled) {
                    wrongSound.currentTime = 0;
                    wrongSound.play();
                }

                if (translationElement) {
                    translationElement.textContent = currentSyllable.answer;
                }
                userTyped = '';
                hintUsed = true;
            }
        }
    });
})();
</script>

</body>
</html>